---
title: "Spatial HW 4"
author: "David Coomes"
date: "March 2, 2020"
output: html_document
---


```{r}

if (!require(knitr)) install.packages("knitr")

```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, cache=TRUE, message=FALSE)
```



```{r load_packages, include=FALSE}

if (!require(spdep)) install.packages("spdep", repos = "http://cran.us.r-project.org")
if (!require(raster)) install.packages("raster", repos = "http://cran.us.r-project.org")
if (!require(leaflet)) install.packages("leaflet", repos = "http://cran.us.r-project.org")
if (!require(SUMMER)) install.packages("SUMMER", repos = "http://cran.us.r-project.org")



```


```{r install_packages, include=FALSE}

if (!isTRUE(requireNamespace("INLA", quietly = TRUE))) {
  install.packages("INLA", repos = c(getOption("repos"), 
          INLA = "https://inla.r-inla-download.org/R/stable"),
          dep=TRUE)
}


if (!require(SUMMER)) install.packages("SUMMER", repos = "http://cran.us.r-project.org")
if (!require(foreign)) install.packages("foreign", repos = "http://cran.us.r-project.org")
if (!require(haven)) install.packages("haven")
if (!require(rgeos)) install.packages("rgeos")
if (!require(rgdal)) install.packages("rgdal")
if (!require(maptools)) install.packages("maptools")
if (!require(sp)) install.packages("sp")
if (!require(spdep)) install.packages("spdep")
if (!require(SpatialEpi)) install.packages("SpatialEpi")
if (!require(RColorBrewer)) install.packages("RColorBrewer")
if (!require(ggplot2)) install.packages("ggplot2")
if (!require(maps)) install.packages("maps")
if (!require(broom)) install.packages("broom")
if (!require(raster)) install.packages("raster")
if (!require(leaflet)) install.packages("leaflet")
if (!require(dplyr)) install.packages("dplyr")
if (!require(tidyverse)) install.packages("tidyverse")
if (!require(SUMMER)) install.packages("SUMMER")


```


```{r install_packages, include=FALSE}

rm(list=ls())
library(haven)
library(INLA)
library(rgdal)
library(maptools)
library(sp)
library(spdep)
library(SpatialEpi)
library(RColorBrewer)
library(ggplot2)
library(maps)
library(broom)
library(raster)
library(leaflet)
library(dplyr)
library(SUMMER)


knitr::opts_chunk$set(echo = FALSE)

```



```{r load_packages, include=FALSE}

rm(list=ls())
library(foreign)
library(haven)
library(INLA)
library(rgdal)
library(maptools)
library(sp)
library(spdep)
library(SpatialEpi)
library(RColorBrewer)
library(ggplot2)
library(maps)
library(broom)
library(raster)
library(leaflet)
library(dplyr)
library(tidyverse)
library(SUMMER)
library(rgeos)

```


```{r, eval=TRUE, results='hide', warning=FALSE, message=FALSE, include=FALSE}

#Cancer data

#using github
link = "https://github.com/dmccoomes/Spatial_epi/raw/master/HW%203/Data/ohio_2019_version.txt"
ohio_canc <- read.table(url(link), header=TRUE)

#pc in office
#ohmap <- readOGR(dsn="C:\\Users\\dcoomes\\Dropbox\\Classes\\Spatial modeling\\HW 3\\Data\\Map data", layer="ohio_map")

#laptop
#ohmap <- readOGR(dsn="/Users/david/Documents/GitHub/Spatial_epi/HW 3/Map data", layer="ohio_map")

#computer in library
ohmap <- readOGR(dsn="C:\\Users\\dcoomes\\Documents\\GitHub\\Spatial_epi\\HW 3\\Map data", layer="ohio_map")

#ordering of regions is not the same among the data sets - how do we align these two?
#summary(ohmap)
#ohmap$COUNTYFP00

#creating neighbor file
nb.map <- poly2nb(ohmap)



```


```{r}

set.seed(03022020)

```


### Question 1

(a) Using Moran's statistic and standardized weights ("W" option) we do not find significant clustering of cancer in our data (p=0.177). The significance is reduced further if we adjust for latitude and longitude to control for large-scale trends (p=0.377). We see similar results (non-significance) using non-standardized weights ("B" option). 

```{r fit_poisson_morans, include=FALSE}


col.W <- nb2listw(nb.map, style="W",zero.policy=TRUE)
col.B <- nb2listw(nb.map, style="B",zero.policy=TRUE)

#Merging map and cancer data together to include lat and lon in cancer data
ohio_canc2 <- ohio_canc
ohmap$fips <- as.numeric(as.character(ohmap$CNTYIDFP00))
ohmap$lat <- ohmap$INTPTLAT00
ohmap$lon <- ohmap$INTPTLON00
ohio_canc2 <- merge(ohio_canc2, ohmap[, c("fips", "lat", "lon")], by.x="fips", by.y="fips")
#ohio_canc2 <- merge(ohio_canc2, ohmap, by="fips")
#ohio_canc2$lat <- as.character(as.numeric(ohio_canc2$lat))
#ohio_canc2$lon <- as.character(as.numeric(ohio_canc2$lon))

ohio_canc2$lat <- as.numeric(as.character(ohio_canc2$lat))
ohio_canc2$lon <- as.numeric(as.character(ohio_canc2$lon))


# kappaval <- function(Obs, fitted, df) {
#   sum((Obs - fitted)^2/fitted)/df
# }

#fitting poisson model without covariates
quasip_mod <- glm(data=ohio_canc, Obs ~ 1, offset=log(Exp), family=quasipoisson())
sidsres <- residuals(quasip_mod, type="pearson")
moran.test(sidsres, col.W)

#running Moran test using B weight option
moran.test(sidsres, col.B)


#fitting poisson model with covariates
quasip_mod.1 <- glm(data=ohio_canc2, Obs ~ lat + lon, offset=log(Exp), family=quasipoisson())
summary(quasip_mod.1)         #latitude is higly significant (p=0.0018), lon is not (p=0.132)
sidsres.1 <- residuals(quasip_mod.1, type="pearson")
moran.test(sidsres.1, col.W)

moran.test(sidsres.1, col.B)


# kappaest <- kappaval(ohio_canc$Obs, mod$fitted, mod$df.resid)
# nMC <- 1000
# ncts <- length(ohio_canc$Exp)
# yMC <- matrix(rpois(n=nMC * ncts, lambda=ohio_canc$Exp),
#               nrow=ncts, ncol=nMC)
# kappaMC <- NULL
# for (i in 1:nMC){
#  modMC <- glm(yMC[,i]~1,offset=log(ohio_canc$Exp),family="quasipoisson")
#  kappaMC[i] <- kappaval(yMC[,i],modMC$fitted,modMC$df.resid)
# }

```

<br>

(b) Using Geary's test and standardized weights ("W" option), we find no evidence of cancer clustering using unadjusted residuals (p=0.208) or residuals adjusted for lat and lon (p=0.381). We see similar results (non-significance) when using non-standardized weights ("B" option).  

```{r fit_geary, include=FALSE}

#Geary test on non-adjusted data 
geary.test(sidsres,col.W)
geary.test(sidsres, col.B)

#Geary test on adjusted data
geary.test(sidsres.1, col.W)
geary.test(sidsres.1, col.B)


```


<br>

Based on these two tests, there is no evidence of cancer clustering in these data.

<br>
<br>

### Question 2

(a) Using the SatScan method of Kulldorff with a maximum population size of 20%, these data are significantly clustered (p=0.044). 

```{r sat_scan, include=FALSE}

library(SpatialEpi)
pop.upper.bound <- 0.2
n.simulations <- 5000
alpha.level <- 0.05

#need to create this - slide 39?
#geo <- latlong2grid(coordinates(ohmap))

ohmap2 <- readShapeSpatial(system.file("shapes/sids.shp", 
                package = "maptools")[1], IDvar = "FIPSNO",
                proj4string = CRS("+proj=longlat +ellps=clrk66"))


#first,  form a matrix containing the centroids
# getLabelPoint <- function(county) {
#   Polygon(county[c("long", "lat")])@labpt
# }


#other way to create centroids - is this the same way and which one is necessary for this exercise
centroids <- latlong2grid(coordinates(ohmap))

#create dataframe from map data
#oh_df <- map_data("county", "ohio")
# oh_df <- map_data("county", "ohio")
# centOH <- by(oh_df, oh_df$subregion, getLabelPoint)
# centOH <- do.call("rbind.data.frame", centOH)
# names(centOH) <- c("long", "lat")

# centroids <- matrix(0, nrow=n, ncol=2)
# for (i in 1:n) {
#   centroids[i, ] <- c(centOH$lat[i], centOH$long[i])
# }

Kpoisson <- kulldorff(centroids, ohio_canc2$Obs, population=ohio_canc2$N,
                      expected.cases=NULL,
                      pop.upper.bound, n.simulations, alpha.level, plot=T)


Kcluster <- Kpoisson$most.likely.cluster$location.IDs.included



```


```{r plot_cluster}

#Why is this not working?
plot(ohmap, axes=TRUE)
plot(ohmap[Kcluster], add=TRUE, col="red")
title("Most Likely Cluster")

```



### Question 3

```{r add_geo, include=FALSE}

if (!require(geoR)) install.packages("geoR")
library(geoR)
data("ca20")
plot(ca20)

```


```{r example}

data("meuse")
zmat <- matrix(cbind(meuse$x, meuse$y, log(meuse$zinc)),
               ncol=3, nrow=155, byrow=F)
geozinc <- as.geodata(zmat, coords.col = c(1, 2),
                      data.col=c(3))

```


```{r cloud_variogram}

cloudca <- variog(ca20, option="cloud")
plot(cloudca, ylab="Semi-variance", xlab="Distance",
     col="blue", cex=0.6)

```



```{r bin_variogram}

#this works, but do we need to include some trend variables? I'm not sure what those are in this dataset
binca <- variog(ca20, uvec=seq(0, 1200, 50))
plot(binca, ylab="Semi-variance", xlab = "Distance",
     cex=0.5, col="blue")

```


(b) 

```{r monte_carlo}

ca.env <- variog.mc.env(ca20, obj=binca)
plot(binca, env=ca.env, xlab="Distance", ylab="Semi-variance")

```


```{r bin_variogram2, eval=FALSE}

#controlling for altitude and exposure - this is probably more useful
binca.1 <- variog(ca20, uvec=seq(0, 1200, 50),
                trend = ~ca20$covariate$altitude + ca20$covariate$area)
plot(binca.1, ylab="Semi-variance", xlab = "Distance",
     cex=0.5, col="blue")

```


```{r monte_carlo2}

ca.env <- variog.mc.env(ca20, obj=binca.1)
plot(binca.1, env=ca.env, xlab="Distance", ylab="Semi-variance")

```


(c) 

```{r ols_fit}

#where do we get the numbers for the fit in this model - do they both come from the binned variogram
olsfit <- variofit(binca, ini=c(150, 184), weights="equal")
olsfit

wlsfit <- variofit(binca, ini=c(150, 184))
wlsfit


```





