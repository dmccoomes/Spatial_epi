---
title: "Spatial Epi HW 2"
author: "David Coomes"
date: "2/5/2020"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


```{r install_packages}

rm(list=ls())
library(haven)
#install.packages("INLA", repos=c(getOption("repos"), INLA="https://inla.r-inla-download.org/R/stable"), dep=TRUE)
library(INLA)
library(rgdal)
library(maptools)
library(sp)
#library(spdep)
install.packages("SpatialEpi", dep=TRUE)
install.packages("deldir", dep=TRUE)
library(SpatialEpi)
library(RColorBrewer)
library(ggplot2)
library(maps)
library(broom)
library(raster)
library(leaflet)
library(dplyr)

```


```{r load_data}

link = "https://github.com/dmccoomes/Spatial_epi/raw/master/HW%202/ohio_2019_version.txt"
ohio_canc <- read.table(url(link), header=TRUE)

#data
#Obs= observed deaths
#Exp = expected deaths

```


```{r map}

zip_ohmap_SHP = "https://github.com/dmccoomes/Spatial_epi/raw/master/HW%202/Ohio%20shape%20files%20(2).zip"

```


```{r, eval=TRUE}

library(utils)
temp=tempfile()
download.file(zip_ohmap_SHP, temp)
unzip(temp)

```


```{r}

#DMC - showing which tempfiles are in the directory

(maps=list.files(pattern = 'shp'))

```


```{r, eval=TRUE, results='hide', warning=FALSE, message=FALSE}
# notice the parameters use in the chunk!!

#ohMap <- readOGR("ohio_map.shp",stringsAsFactors=F) 

#From pc
ohio_map <- readOGR(dsn="/Users/david/Desktop/Dave/school/Spatial Epi/HW 2/HW 2_data", layer = "ohio_map")

#From laptop
ohio_map <- readOGR(dsn="/Users/david/Documents/GitHub/Spatial_epi/HW 2/Ohio shape files", layer="ohio_map")


```


```{r smr}

#creating SMRs
ohio_canc$smr <- ohio_canc$Obs/ohio_canc$Exp

```


```{r merging_data}

ohio_map$fips <- as.numeric(as.character(ohio_map$CNTYIDFP00))
ohio_map <- merge(ohio_map,ohio_canc,by="fips")

```


```{r}

#for laptop
setwd("/Users/david/Documents/GitHub/Spatial_epi/HW 2")
pdf("ohio_map_spplot_default.pdf", # name of file you want to save
    width = 8, # width of plot
    height = 8) # height of plot

spplot(ohio_map, c("Obs"))

#Not sure what this is doing - it doesn't seem to do much 
dev.off()

num_bins <- 8

# choose a color palette
plotting_color_palette <- rev(brewer.pal(8, "RdBu"))

# set breakpoints for plotting
quants <- round(quantile(ohio_map@data$Obs, seq(0, 1, length.out = num_bins)),2)
ohio_map@data$obs_cut <- cut(ohio_map@data$Obs, breaks = c(quants, Inf), include.lowest = TRUE, right = FALSE)   # I modified the breaks

# start graphical device
pdf("ohio_map_spplot_pretty.pdf", width = 8, height = 8)

# make the pretty plot
spplot(ohio_map["obs_cut"],
       colorkey = list(height = 1, 
                       labels = list(at = seq(0.5, length(quants) -0.5), 
                                     labels = quants)),
       col.regions = colorRampPalette(plotting_color_palette)(length(quants)))

# close graphical device
dev.off()


```


```{r}

ohio_df <- tidy(ohio_map)


```

